<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Next Read - Find Your Next Book</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      padding: 16px;
      line-height: 1.6;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 24px;
    }

    h1 {
      font-size: 28px;
      color: #333;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #666;
      font-size: 14px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .book-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border-left: 4px solid #ddd;
    }

    .book-card.available {
      border-left-color: #28a745;
    }

    .book-header {
      margin-bottom: 12px;
    }

    .book-title {
      font-size: 20px;
      font-weight: 600;
      color: #0066cc;
      margin-bottom: 6px;
      text-decoration: none;
      display: inline;
      line-height: 1.4;
    }

    .book-title:hover {
      text-decoration: underline;
    }

    .book-meta {
      color: #666;
      font-size: 14px;
      margin-bottom: 12px;
      line-height: 1.6;
    }

    .book-author {
      font-weight: 500;
    }

    .book-series {
      color: #888;
      font-style: italic;
    }

    .book-stats {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .rating {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      color: #333;
    }

    .rating-stars {
      color: #ffa500;
      font-size: 16px;
    }

    .rating-count {
      color: #888;
      font-size: 13px;
    }

    .genres {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .genre-tag {
      background: #f0f0f0;
      color: #555;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .availability-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .availability-badge.available {
      background: #d4edda;
      color: #155724;
    }

    .availability-badge.unavailable {
      background: #f8d7da;
      color: #721c24;
    }

    .availability-badge.unknown {
      background: #e2e3e5;
      color: #383d41;
    }

    .book-links {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .book-link {
      padding: 8px 14px;
      background: #0066cc;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      transition: background 0.2s;
    }

    .book-link:hover {
      background: #0052a3;
    }

    .book-link.secondary {
      background: #6c757d;
    }

    .book-link.secondary:hover {
      background: #5a6268;
    }

    .book-count {
      text-align: center;
      color: #666;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .enrichment-status {
      color: #999;
      font-size: 12px;
      font-style: italic;
    }

    .refresh-btn {
      display: block;
      width: 100%;
      padding: 12px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      margin-bottom: 24px;
    }

    .refresh-btn:hover {
      background: #5a6268;
    }

    @media (max-width: 600px) {
      .libby-links {
        flex-direction: column;
      }

      .libby-link {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìö Next Read</h1>
      <p class="subtitle">Find your next book from Storygraph on Libby</p>
    </header>

    <button class="refresh-btn" onclick="loadBooks()">üîÑ Refresh Books</button>

    <div id="content">
      <div class="loading">
        <div class="spinner"></div>
        <p>Loading your to-read pile...</p>
      </div>
    </div>
  </div>

  <script>
    async function loadBooks() {
      const content = document.getElementById('content');
      content.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading your to-read pile...</p>
        </div>
      `;

      try {
        // Layer 1: Load basic books from Storygraph (fast)
        console.log('Loading basic books...');
        const response = await fetch('/api/books/basic');
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load books');
        }

        if (data.books.length === 0) {
          content.innerHTML = `
            <div class="error">
              No books found in your to-read pile.
            </div>
          `;
          return;
        }

        // Display basic books immediately
        let html = `<div class="book-count">${data.count} books in your to-read pile <span class="enrichment-status">(Loading details...)</span></div>`;
        content.innerHTML = html;

        // Create book cards container
        const booksContainer = document.createElement('div');
        content.appendChild(booksContainer);

        // Render basic book cards
        data.books.forEach((book, index) => {
          const bookCard = createBookCard(book, index, true);
          booksContainer.appendChild(bookCard);
        });

        // Layer 2 & 3: Progressively enrich each book
        console.log('Starting progressive enrichment...');
        for (let index = 0; index < data.books.length; index++) {
          try {
            const enrichResponse = await fetch(`/api/books/${index}/enrich`);
            const enrichData = await enrichResponse.json();

            if (enrichData.success && enrichData.book) {
              // Update the book card with enriched data
              const bookCard = document.getElementById(`book-card-${index}`);
              if (bookCard) {
                const newCard = createBookCard(enrichData.book, index, false);
                bookCard.replaceWith(newCard);
              }
            }
          } catch (error) {
            console.error(`Failed to enrich book ${index}:`, error);
          }
        }

        // Update status message
        const statusEl = document.querySelector('.enrichment-status');
        if (statusEl) {
          statusEl.textContent = '(All details loaded)';
        }

      } catch (error) {
        content.innerHTML = `
          <div class="error">
            <strong>Error:</strong> ${escapeHtml(error.message)}
          </div>
        `;
      }
    }

    function createBookCard(book, index, isLoading) {
      const div = document.createElement('div');
      div.id = `book-card-${index}`;
      div.className = `book-card ${book.libbyAvailability?.isAvailable ? 'available' : ''}`;

      if (isLoading) {
        // Basic card while enriching
        div.innerHTML = `
          <div class="book-header">
            <a href="${book.storygraphUrl}" target="_blank" class="book-title">
              ${escapeHtml(book.title)}
            </a>
          </div>
          <div class="book-meta">
            <span class="book-author">by ${escapeHtml(book.author)}</span>
          </div>
          <div class="loading" style="padding: 10px 0;">
            <div class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></div>
            <p style="font-size: 12px; color: #888;">Loading details...</p>
          </div>
        `;
      } else {
        // Full enriched card
        // Prioritize Hebrew title, fallback to English, then original
        const displayTitle = book.editions?.hebrewTitle || book.editions?.englishTitle || book.title;

        // Prioritize Hebrew author, fallback to original
        const displayAuthor = book.editions?.hebrewAuthor || book.author;

        const series = book.editions?.series;
        const rating = book.editions?.rating;
        const genres = book.editions?.genres || [];
        const availability = book.libbyAvailability;

        // Determine availability status
        let availabilityClass = 'unknown';
        let availabilityText = 'Availability unknown';
        let availabilityIcon = '‚ùì';

        if (availability) {
          if (availability.isAvailable) {
            availabilityClass = 'available';
            availabilityIcon = '‚úì';
            availabilityText = `Available now on Libby`;
            if (availability.format) {
              availabilityText += ` - ${availability.format.charAt(0).toUpperCase() + availability.format.slice(1)}`;
            }
          } else {
            availabilityClass = 'unavailable';
            availabilityIcon = '‚úï';
            availabilityText = 'Not currently available on Libby';
          }
        }

        // Generate star rating display
        const stars = rating ? '‚òÖ'.repeat(Math.round(rating.average)) + '‚òÜ'.repeat(5 - Math.round(rating.average)) : '';

        div.innerHTML = `
          <div class="book-header">
            <a href="${book.storygraphUrl}" target="_blank" class="book-title">
              ${escapeHtml(displayTitle)}
            </a>
          </div>

          <div class="book-meta">
            <span class="book-author">by ${escapeHtml(displayAuthor)}</span>
            ${series ? ` ‚Ä¢ <span class="book-series">${escapeHtml(series)}</span>` : ''}
          </div>

          ${rating || genres.length > 0 ? `
            <div class="book-stats">
              ${rating ? `
                <div class="rating">
                  <span class="rating-stars">${stars}</span>
                  <span>${rating.average.toFixed(1)}</span>
                  <span class="rating-count">(${rating.count.toLocaleString()})</span>
                </div>
              ` : ''}
              ${genres.length > 0 ? `
                <div class="genres">
                  ${genres.slice(0, 3).map(genre => `
                    <span class="genre-tag">${escapeHtml(genre)}</span>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          ` : ''}

          <div class="availability-badge ${availabilityClass}">
            <span>${availabilityIcon}</span>
            <span>${availabilityText}</span>
          </div>

          <div class="book-links">
            ${availability?.url ? `
              <a href="${availability.url}" target="_blank" class="book-link">
                Search on Libby
              </a>
            ` : ''}
            <a href="${book.storygraphUrl}" target="_blank" class="book-link secondary">
              View on Storygraph
            </a>
          </div>
        `;
      }

      return div;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Load books on page load
    loadBooks();
  </script>
</body>
</html>
